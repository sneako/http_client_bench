worker_processes auto;
error_log logs/error.log info;

pid logs/nginx.pid;

events {
  worker_connections 4096;
}

http {
  init_worker_by_lua_block {
    math.randomseed(ngx.now() * 1000 + ngx.worker.pid())
  }

  default_type  application/octet-stream;
  sendfile      on;
  tcp_nopush    on;
  keepalive_timeout  30;
  client_max_body_size 10m;
  access_log off;

  server {
    listen 8080;
    server_name _;

    location = /health {
      default_type text/plain;
      return 200 "OK";
    }

    location = /small {
      default_type application/octet-stream;
      # 4096-byte payload
      root html/static;
      try_files /small.bin =404;
    }

    location = /medium {
      default_type application/octet-stream;
      # 131072-byte payload
      root html/static;
      try_files /medium.bin =404;
    }

    location = /large {
      default_type application/octet-stream;
      # 1048576-byte payload
      root html/static;
      try_files /large.bin =404;
    }

    location = /json {
      default_type application/json;
      root html/static;
      try_files /json.json =404;
    }

    location = /echo {
      content_by_lua_block {
        ngx.req.read_body()
        local data = ngx.req.get_body_data()
        if not data then
          local file = ngx.req.get_body_file()
          if file then
            local f = io.open(file, "rb")
            if f then
              data = f:read("*a")
              f:close()
            else
              data = ""
            end
          else
            data = ""
          end
        end
        ngx.print(data)
      }
    }

    location = /stream {
      default_type application/octet-stream;
      # 1048576 bytes total in 64 flushed chunks
      content_by_lua_block {
        local chunk = string.rep("a", 16384)
        for _ = 1, 64 do
          ngx.print(chunk)
          ngx.flush(true)
        end
      }
    }

    location ~ ^/delay/(\d+)$ {
      default_type text/plain;
      content_by_lua_block {
        local ms = tonumber(ngx.var[1]) or 0
        if ms < 0 then
          ms = 0
        end
        ngx.sleep(ms / 1000)
        ngx.say("delayed ", ms)
      }
    }

    location ~ ^/delay_post/(\d+)$ {
      default_type application/json;
      content_by_lua_block {
        ngx.req.read_body()
        local ms = tonumber(ngx.var[1]) or 0
        if ms < 0 then
          ms = 0
        end
        ngx.sleep(ms / 1000)
        if math.random(10) == 1 then
          local f = io.open("html/static/json_32k.json", "rb")
          if f then
            local data = f:read("*a")
            f:close()
            ngx.print(data)
          else
            ngx.say("{\"error\":\"missing json_32k\"}")
          end
        else
          ngx.say("delayed ", ms)
        end
      }
    }
  }

  server {
    listen 8443 ssl http2;
    server_name _;

    ssl_certificate certs/bench.crt;
    ssl_certificate_key certs/bench.key;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location = /health {
      default_type text/plain;
      return 200 "OK";
    }

    location = /small {
      default_type application/octet-stream;
      # 4096-byte payload
      root html/static;
      try_files /small.bin =404;
    }

    location = /medium {
      default_type application/octet-stream;
      # 131072-byte payload
      root html/static;
      try_files /medium.bin =404;
    }

    location = /large {
      default_type application/octet-stream;
      # 1048576-byte payload
      root html/static;
      try_files /large.bin =404;
    }

    location = /json {
      default_type application/json;
      root html/static;
      try_files /json.json =404;
    }

    location = /echo {
      content_by_lua_block {
        ngx.req.read_body()
        local data = ngx.req.get_body_data()
        if not data then
          local file = ngx.req.get_body_file()
          if file then
            local f = io.open(file, "rb")
            if f then
              data = f:read("*a")
              f:close()
            else
              data = ""
            end
          else
            data = ""
          end
        end
        ngx.print(data)
      }
    }

    location = /stream {
      default_type application/octet-stream;
      # 1048576 bytes total in 64 flushed chunks
      content_by_lua_block {
        local chunk = string.rep("a", 16384)
        for _ = 1, 64 do
          ngx.print(chunk)
          ngx.flush(true)
        end
      }
    }

    location ~ ^/delay/(\d+)$ {
      default_type text/plain;
      content_by_lua_block {
        local ms = tonumber(ngx.var[1]) or 0
        if ms < 0 then
          ms = 0
        end
        ngx.sleep(ms / 1000)
        ngx.say("delayed ", ms)
      }
    }

    location ~ ^/delay_post/(\d+)$ {
      default_type application/json;
      content_by_lua_block {
        ngx.req.read_body()
        local ms = tonumber(ngx.var[1]) or 0
        if ms < 0 then
          ms = 0
        end
        ngx.sleep(ms / 1000)
        if math.random(10) == 1 then
          local f = io.open("html/static/json_32k.json", "rb")
          if f then
            local data = f:read("*a")
            f:close()
            ngx.print(data)
          else
            ngx.say("{\"error\":\"missing json_32k\"}")
          end
        else
          ngx.say("delayed ", ms)
        end
      }
    }
  }
}
